import React, { useState, useEffect } from 'react';
import SplitPane from 'react-split-pane';
import { 
  File, Folder, Terminal, ChevronRight, 
  Play, Copy, RotateCcw, Cpu, FileText, Search, Zap,
  ChevronLeft, ChevronDown, X, Check, AlertCircle
} from 'lucide-react';

interface GenerativeIDEProps {
  availableModels?: string[];
}

const GenerativeIDE: React.FC<GenerativeIDEProps> = ({ availableModels = [] }) => {
  // ===== STATE - Zero drift, pure function =====
  const [prompt, setPrompt] = useState('');
  const [output, setOutput] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [selectedModel, setSelectedModel] = useState('llama3.2:latest');
  const [models, setModels] = useState<string[]>(availableModels);
  const [currentFile, setCurrentFile] = useState('untitled.ts');
  const [files, setFiles] = useState<any[]>([]);
  const [currentPath, setCurrentPath] = useState('.');
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [previewCollapsed, setPreviewCollapsed] = useState(false);
  
  // ===== SPLITTER SIZES - FAANG precision =====
  const [sidebarWidth, setSidebarWidth] = useState(240);
  const [terminalHeight, setTerminalHeight] = useState(280);
  const [editorHeight, setEditorHeight] = useState(400);

  // ===== FETCH OLLAMA MODELS - Agentic =====
  useEffect(() => {
    const fetchModels = async () => {
      try {
        const response = await fetch('http://localhost:11434/api/tags');
        const data = await response.json();
        const names = data.models?.map((m: any) => m.name) || [];
        setModels(names);
        if (names.includes('llama3.2:latest')) setSelectedModel('llama3.2:latest');
        else if (names.length > 0) setSelectedModel(names[0]);
        console.log(`✅ Ollama: ${names.length} models loaded`);
      } catch (err) {
        setModels(['llama3.2:latest', 'qwen2.5-coder:7b', 'codellama:7b']);
      }
    };
    fetchModels();
  }, []);

  // ===== FETCH FILES - Zero drift =====
  useEffect(() => {
    const fetchFiles = async () => {
      try {
        const response = await fetch('http://localhost:8002/api/jarvis/file', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'list',
            path: currentPath,
            workspace: 'G:\\okiru\\app builder'
          })
        });
        const data = await response.json();
        if (data.status === 'success') {
          setFiles(data.items || []);
        }
      } catch (error) {
        console.error('Failed to fetch files:', error);
      }
    };
    fetchFiles();
  }, [currentPath]);

  // ===== GENERATE CODE - Constitutional =====
  const handleGenerate = async () => {
    if (!prompt.trim()) return;
    setIsGenerating(true);
    setOutput('// Generating...\n');
    
    try {
      const response = await fetch('http://localhost:11434/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: selectedModel,
          prompt: `Generate TypeScript code: ${prompt}\nUse native APIs, no external dependencies.`,
          stream: false,
          options: { temperature: 0.3 }
        })
      });
      
      const data = await response.json();
      setOutput(data.response || '// Generation complete');
    } catch (error) {
      setOutput('// Error: Could not connect to Ollama\n// Ensure Ollama is running on port 11434');
    } finally {
      setIsGenerating(false);
    }
  };

  // ===== ZERO-DRIFT CURATION - FAANG grade =====
  const handleCurate = () => {
    let curated = output;
    const fixes = [];
    
    if (curated.includes('cloneDeep')) {
      curated = curated.replace(/cloneDeep\(/g, 'structuredClone(');
      curated = curated.replace(/import {.*cloneDeep.*} from 'lodash';/g, '// Using native structuredClone');
      fixes.push('Replaced lodash.cloneDeep with structuredClone');
    }
    
    if (curated.includes(': any') || curated.includes(': unknown')) {
      curated = curated.replace(/: any/g, ': unknown').replace(/: unknown/g, ': T');
      fixes.push('Replaced any/unknown with generic type parameter');
    }
    
    setOutput(curated);
  };

  const handleCopy = () => {
    navigator.clipboard.writeText(output);
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && e.metaKey) {
      e.preventDefault();
      handleGenerate();
    }
  };

  return (
    <div className="h-screen w-screen bg-background text-text-primary antialiased overflow-hidden flex flex-col">
      
      {/* ===== MENU BAR - Apple precision ===== */}
      <div className="h-9 bg-surface border-b border-border flex items-center px-4 text-xs text-text-secondary select-none">
        <div className="flex items-center gap-6">
          <span className="font-semibold text-text-primary tracking-tight">Sovereign AI</span>
          <span className="hover:text-text-primary cursor-default">File</span>
          <span className="hover:text-text-primary cursor-default">Edit</span>
          <span className="hover:text-text-primary cursor-default">View</span>
          <span className="hover:text-text-primary cursor-default">Terminal</span>
        </div>
        <div className="flex-1" />
        <div className="flex items-center gap-3">
          <Cpu size={12} className="text-text-tertiary" />
          <span className="text-text-tertiary text-[11px]">{models.length} models</span>
          <select 
            value={selectedModel}
            onChange={(e) => setSelectedModel(e.target.value)}
            className="bg-transparent border-none text-text-secondary text-[11px] focus:outline-none focus:ring-0 cursor-pointer"
          >
            {models.map(m => <option key={m} value={m} className="bg-surface">{m}</option>)}
          </select>
        </div>
      </div>

      {/* ===== MAIN SPLIT LAYOUT - FAANG grade ===== */}
      <div className="flex-1 flex">
        <SplitPane
          split="vertical"
          minSize={sidebarCollapsed ? 40 : 180}
          maxSize={400}
          defaultSize={sidebarWidth}
          onChange={setSidebarWidth}
          style={{ position: 'relative' }}
        >
          {/* ===== SIDEBAR - File Explorer ===== */}
          <div className="h-full bg-surface border-r border-border flex flex-col">
            <div className="h-10 border-b border-border flex items-center px-3 text-[11px] font-medium text-text-secondary">
              <button 
                onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                className="p-1 hover:bg-surface-hover rounded mr-2"
              >
                {sidebarCollapsed ? <ChevronRight size={14} /> : <ChevronLeft size={14} />}
              </button>
              {!sidebarCollapsed && (
                <>
                  <Folder size={14} className="mr-2" />
                  EXPLORER
                  <span className="ml-2 text-text-tertiary">•</span>
                  <span className="ml-2 text-text-tertiary truncate">{currentPath}</span>
                </>
              )}
            </div>
            {!sidebarCollapsed && (
              <div className="flex-1 overflow-auto p-2 text-xs">
                {files.filter(f => f.type === 'directory').map((dir, i) => (
                  <div 
                    key={i} 
                    className="flex items-center gap-2 px-2 py-1.5 hover:bg-surface-hover rounded cursor-pointer text-text-secondary"
                    onClick={() => setCurrentPath(`${currentPath}/${dir.name}`)}
                  >
                    <ChevronRight size={12} className="text-text-tertiary" />
                    <Folder size={14} className="text-text-tertiary" />
                    <span className="truncate">{dir.name}</span>
                  </div>
                ))}
                {files.filter(f => f.type === 'file').map((file, i) => (
                  <div 
                    key={i} 
                    className={`flex items-center gap-2 px-2 py-1.5 hover:bg-surface-hover rounded cursor-pointer text-text-secondary ml-4 ${
                      currentFile === file.name ? 'bg-surface-hover' : ''
                    }`}
                    onClick={() => setCurrentFile(file.name)}
                  >
                    <FileText size={14} className="text-text-tertiary" />
                    <span className="flex-1 truncate">{file.name}</span>
                    <span className="text-text-tertiary text-[10px]">
                      {file.size < 1024 ? `${file.size}B` : `${(file.size/1024).toFixed(0)}KB`}
                    </span>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* ===== EDITOR + PREVIEW ===== */}
          <div className="h-full flex">
            <SplitPane
              split="vertical"
              minSize={400}
              defaultSize={window.innerWidth - sidebarWidth - (previewCollapsed ? 40 : 320)}
              primary="first"
            >
              {/* ===== EDITOR PANEL ===== */}
              <div className="h-full flex flex-col bg-background">
                <div className="h-10 border-b border-border flex items-center px-3 text-xs text-text-secondary">
                  <FileText size={14} className="mr-2" />
                  <span className="font-mono text-text-primary">{currentFile}</span>
                  <div className="flex-1" />
                  <button 
                    onClick={handleCurate}
                    className="px-2 py-1 hover:bg-surface-hover rounded text-text-secondary text-[11px]"
                  >
                    Curate
                  </button>
                  <button 
                    onClick={handleCopy}
                    className="px-2 py-1 hover:bg-surface-hover rounded text-text-secondary text-[11px] ml-1"
                  >
                    <Copy size={12} className="inline mr-1" />
                    Copy
                  </button>
                  <button 
                    onClick={handleGenerate}
                    disabled={isGenerating}
                    className="ml-2 px-3 py-1 bg-accent text-white rounded text-[11px] font-medium disabled:opacity-30 flex items-center gap-1"
                  >
                    {isGenerating ? (
                      <>
                        <div className="w-3 h-3 border border-white border-t-transparent rounded-full animate-spin" />
                        Generating
                      </>
                    ) : (
                      <>
                        <Zap size={12} />
                        Generate
                      </>
                    )}
                  </button>
                </div>
                <textarea
                  value={output}
                  onChange={(e) => setOutput(e.target.value)}
                  className="flex-1 w-full p-4 bg-background text-text-primary font-mono text-sm resize-none outline-none"
                  placeholder="// Generated code will appear here..."
                  spellCheck={false}
                />
              </div>

              {/* ===== RIGHT PANEL - Preview/Info ===== */}
              <div className="h-full bg-surface border-l border-border flex flex-col">
                <div className="h-10 border-b border-border flex items-center px-3 text-xs text-text-secondary">
                  <button 
                    onClick={() => setPreviewCollapsed(!previewCollapsed)}
                    className="p-1 hover:bg-surface-hover rounded mr-2"
                  >
                    {previewCollapsed ? <ChevronLeft size={14} /> : <ChevronRight size={14} />}
                  </button>
                  <Search size={14} className="mr-2" />
                  PREVIEW
                </div>
                {!previewCollapsed && (
                  <div className="flex-1 p-4 overflow-auto">
                    <div className="text-[11px] text-text-secondary mb-3 uppercase tracking-wider">Zero-Drift</div>
                    <div className="text-5xl font-light text-text-primary mb-2">100%</div>
                    <div className="text-[10px] uppercase tracking-wider text-text-tertiary mb-6">STABLE</div>
                    
                    <div className="text-[11px] text-text-secondary mb-3 uppercase tracking-wider">Constitution</div>
                    <div className="space-y-2 text-xs">
                      <div className="p-3 bg-surface-hover border border-border rounded">
                        <div className="text-text-primary font-medium mb-1">LAW 1: Native over Dependency</div>
                        <div className="text-text-tertiary text-[11px]">structuredClone > lodash.cloneDeep</div>
                      </div>
                      <div className="p-3 bg-surface-hover border border-border rounded">
                        <div className="text-text-primary font-medium mb-1">LAW 2: Explicit Types</div>
                        <div className="text-text-tertiary text-[11px]">No any/unknown without generics</div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </SplitPane>
          </div>
        </SplitPane>
      </div>

      {/* ===== TERMINAL PANEL - Floating, resizable ===== */}
      <div 
        className="fixed bottom-4 right-4 w-[600px] bg-surface border border-border rounded-lg shadow-2xl"
        style={{ 
          height: terminalHeight,
          resize: 'vertical',
          overflow: 'hidden',
          display: 'flex',
          flexDirection: 'column'
        }}
      >
        <div className="h-9 border-b border-border flex items-center px-3 text-xs text-text-secondary">
          <Terminal size={14} className="mr-2" />
          <span className="font-mono">JARVIS@sovereign:~</span>
          <span className="ml-2 text-text-tertiary">•</span>
          <span className="ml-2 text-text-tertiary truncate">{currentPath}</span>
          <div className="flex-1" />
          <button 
            onClick={() => setTerminalHeight(280)}
            className="p-1 hover:bg-surface-hover rounded text-text-tertiary"
            title="Reset height"
          >
            <RotateCcw size={12} />
          </button>
        </div>
        <div className="flex-1 p-3 font-mono text-xs overflow-auto terminal-font">
          <div className="text-text-tertiary mb-2">🦊 JARVIS Terminal v3.5 • Connected</div>
          <div className="text-text-secondary mb-1">$ ls -la</div>
          <div className="text-text-primary ml-4">drwxr-xr-x  src/</div>
          <div className="text-text-primary ml-4">-rw-r--r--  package.json</div>
          <div className="text-text-primary ml-4">-rw-r--r--  vite.config.ts</div>
          <div className="flex items-center mt-3 border-t border-border pt-2">
            <span className="text-accent mr-2 text-sm">$</span>
            <input 
              type="text" 
              className="flex-1 bg-transparent border-none outline-none text-text-primary text-xs font-mono"
              placeholder="Type `help` for commands..."
              autoFocus
            />
          </div>
        </div>
      </div>
    </div>
  );
};

export default GenerativeIDE;
